<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lyrics</title>
  <style>
    :root {
      --side-width: 400px;
      --side-padding: 16px;
    }

    html, body {
      font-size: 16px;
      margin: 0;
      padding: 0;
    }

    .side {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--side-width);
      height: 100%;
      background-color: #f0f0f0;
      padding: 16px;
    }

    .mt-4 {
      margin-top: 16px;
    }

    #lrcArea {
      margin-left: calc(var(--side-width) + var(--side-padding) * 2);
      height: 1000px;
      padding: 0 16px;
    }
  </style>
</head>
<body>
  <div class="side">
    <div><span>lrc: </span><input id="lrc" type="file" name="lrc"></div>
    <div class="mt-4"><span>sound: </span><input id="sound" type="file" name="sound"></div>
    <div class="mt-4"><video id="soundVideo" controls width="400"></video></div>
  </div>

  <div id="lrcArea">

  </div>

  <script type="module">
    import { Lyrics } from './lyrics.js'

    const lrcInput = document.getElementById('lrc')
    const soundInput = document.getElementById('sound')
    const soundVideo = document.getElementById('soundVideo')
    const lrcArea = document.getElementById('lrcArea')

    const decoder = new TextDecoder('shift-jis')
    const encoder = new TextEncoder('shift-jis')

    let lrc = null
    let lrcData = []
    let cursor = { row: 0, col: 0 }

    soundInput.addEventListener('change', (e) => {
      if (soundVideo.src) {
        URL.revokeObjectURL(soundVideo.src)
      }
      const sound = e.target.files[0]
      soundVideo.src = URL.createObjectURL(sound)
    })

    lrcInput.addEventListener('change', (e) => {
      const reader = new FileReader()
      reader.onload = (e) => {
        const lrcText = decoder.decode(new Uint8Array(e.target.result))
        lrc = Lyrics.parse(lrcText)
        console.log(lrc)

        lrcData = lrc.data
        lrcArea.innerHTML = ''
        lrcData.forEach((line) => {
          const p = document.createElement('p')
          line.forEach((block) => {
            const span = document.createElement('span')
            span.style.display = 'inline-block'
            span.style.border = '1px solid black'
            span.style.height = '40px'
            span.style.boxSizing = 'border-box'
            span.style.padding = '8px'
            span.style.verticalAlign = 'bottom'
            span.textContent = block.word
            p.appendChild(span)
          })
          lrcArea.appendChild(p)
        })
      }
      reader.readAsArrayBuffer(e.target.files[0])
    })

    const isVideoPlaying = video => Boolean(video.currentTime > 0 && !video.paused && !video.ended && video.readyState > 2);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') {
        if (!isVideoPlaying(soundVideo) || lrcData.length === 0) return
        const currentTime = soundVideo.currentTime
        lrcArea.children[cursor.row].children[cursor.col].style.color = 'red'
        lrcArea.children[cursor.row].children[cursor.col].style.border = '1px solid red'
        lrcData[cursor.row][cursor.col].time = currentTime
        if (cursor.col < lrcData[cursor.row].length - 1) {
          cursor.col++
        } else if (cursor.row < lrcData.length - 1) {
          cursor.row++
          cursor.col = 0
        }
      } else if (e.key === 'ArrowLeft') {
        if (!isVideoPlaying(soundVideo) || lrcData.length === 0) return
        if (cursor.col > 0) {
          cursor.col--
        } else if (cursor.row > 0) {
          cursor.row--
          cursor.col = lrcData[cursor.row].length - 1
        } else {
          return
        }
        lrcArea.children[cursor.row].children[cursor.col].style.color = ''
        lrcArea.children[cursor.row].children[cursor.col].style.border = '1px solid black'
        soundVideo.currentTime = lrcData[cursor.row][cursor.col].time - 1
        delete lrcData[cursor.row][cursor.col].time
      } else if (e.key === 'Enter') {
        console.log(lrc.toString())
      }
    })
  </script>
</body>
</html>
